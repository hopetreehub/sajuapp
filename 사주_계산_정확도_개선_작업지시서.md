# 사주 계산 정확도 개선 작업지시서

## 🚨 문제 상황 분석

### 발견된 오류
- **테스트 케이스**: 1971년 11월 17일 04시 양력
- **올바른 사주**: 신해 기해 병오 경인 ✅
- **현재 DB 저장된 잘못된 사주**: 신해 경자 을미 무인 ❌

### 오류 원인 분석
1. **정확한 계산기 존재**: `accurateSajuCalculator.ts`가 올바른 결과 계산
2. **구현 상태**: Backend에서 이미 정확한 계산기를 import하고 있음
3. **추정 원인**: 기존 DB 데이터가 이전 버전의 부정확한 계산기로 저장됨

## ✅ 확인된 사실들

### 🎯 정확한 계산기 테스트 결과
```bash
# 테스트 실행 결과
cd packages/backend/services/calendar
node -e "
const { calculateCompleteSaju } = require('./dist/utils/accurateSajuCalculator.js');
const result = calculateCompleteSaju(1971, 11, 17, 4, 0, false);
console.log('전체 사주:', result.fullSaju);
"

# 출력: 신해 기해 병오 경인 ✅ (정확함)
```

### 🔧 현재 시스템 상태
1. **백엔드**: 정확한 계산기 이미 적용 완료
2. **API**: `/api/calendar/customers` 정상 작동
3. **프론트엔드**: 포트 4001에서 정상 실행
4. **데이터 문제**: 기존 DB의 부정확한 사주 데이터

## 📋 해결 방안

### 1단계: 기존 고객 사주 데이터 재계산 및 업데이트

#### 1.1 데이터베이스 백업
```bash
# customers.db 백업 생성
cd packages/backend/services/calendar/customer
cp customers.db customers_backup_$(date +%Y%m%d_%H%M%S).db
```

#### 1.2 사주 재계산 스크립트 생성
```javascript
// recalculate-saju-data.js
const Database = require('better-sqlite3');
const { calculateCompleteSaju } = require('../dist/utils/accurateSajuCalculator.js');

const db = new Database('./customer/customers.db');

// 모든 고객 데이터 조회
const customers = db.prepare('SELECT * FROM customers').all();

console.log(`총 ${customers.length}명의 고객 사주 재계산 시작...`);

for (const customer of customers) {
  try {
    // 생년월일시 파싱
    const [year, month, day] = customer.birth_date.split('-').map(Number);
    const [hour, minute] = customer.birth_time.split(':').map(Number);
    const isLunar = customer.lunar_solar === 'lunar';
    
    // 정확한 사주 계산
    const accurateSaju = calculateCompleteSaju(year, month, day, hour, minute, isLunar);
    
    // 기존 데이터와 비교
    const oldSaju = JSON.parse(customer.saju_data || '{}');
    const newSajuText = accurateSaju.fullSaju;
    const oldSajuText = oldSaju.fullSaju || 'N/A';
    
    if (newSajuText !== oldSajuText) {
      console.log(`🔄 ${customer.name}: ${oldSajuText} → ${newSajuText}`);
      
      // 데이터베이스 업데이트
      db.prepare(`
        UPDATE customers 
        SET saju_data = ?, updated_at = CURRENT_TIMESTAMP 
        WHERE id = ?
      `).run(JSON.stringify(accurateSaju), customer.id);
    } else {
      console.log(`✅ ${customer.name}: 이미 정확함`);
    }
    
  } catch (error) {
    console.error(`❌ ${customer.name} 계산 실패:`, error.message);
  }
}

console.log('사주 재계산 완료!');
db.close();
```

#### 1.3 재계산 실행
```bash
cd packages/backend/services/calendar
node recalculate-saju-data.js
```

### 2단계: 신규 고객 등록 시 정확한 계산기 적용 확인

#### 2.1 Customer API 점검
```typescript
// customers.ts에서 확인 필요
import { calculateCompleteSaju } from '../utils/accurateSajuCalculator'; // ✅ 이미 적용됨
```

#### 2.2 API 테스트
```bash
# 신규 고객 등록 테스트
curl -X POST http://localhost:4003/api/calendar/customers \
  -H "Content-Type: application/json" \
  -d '{
    "name": "테스트사용자",
    "birth_date": "1971-11-17",
    "birth_time": "04:00",
    "lunar_solar": "solar",
    "gender": "male",
    "phone": "010-0000-0000"
  }'

# 결과 확인: 신해 기해 병오 경인이 나와야 함
```

### 3단계: 프론트엔드 사주 표시 검증

#### 3.1 UnifiedSajuAnalysisPage 테스트
1. 브라우저에서 http://localhost:4001 접속
2. 사주 분석 페이지 이동
3. 1971.11.17.04시 고객 선택
4. **예상 결과**: 신해 기해 병오 경인 표시 ✅
5. **기존 잘못된 결과**: 신해 경자 을미 무인 ❌

#### 3.2 고객 관리 페이지 확인
1. 고객 관리 페이지 접속
2. 모든 고객의 사주 데이터 정확성 확인
3. 사주 차트 시각화 정확성 검증

## 🔥 즉시 실행 단계

### Phase 1: 긴급 데이터 수정 (15분)
```bash
# 1. DB 백업
cd packages/backend/services/calendar
cp customer/customers.db customer/customers_backup.db

# 2. 재계산 스크립트 생성 및 실행
# (위의 recalculate-saju-data.js 스크립트 생성)
node recalculate-saju-data.js
```

### Phase 2: 시스템 재시작 및 검증 (10분)
```bash
# 1. 백엔드 서비스 재시작
# (현재 실행중인 프로세스들 확인 후 재시작)

# 2. API 테스트
curl http://localhost:4003/api/calendar/customers?page=1&limit=5

# 3. 프론트엔드에서 사주 데이터 확인
# http://localhost:4001에서 고객 선택하여 사주 정확성 확인
```

### Phase 3: 전체 시스템 검증 (10분)
1. **모든 고객 데이터 점검**: 6명 모든 고객의 사주 정확성 검증
2. **차트 시각화 확인**: UnifiedSajuRadarChart에서 올바른 데이터 표시 확인
3. **오행균형도 검증**: 정확한 오행 비율 계산 확인

## 📊 검증 체크리스트

### ✅ 필수 확인 사항
- [ ] 1971.11.17.04시 → 신해 기해 병오 경인 정확 표시
- [ ] 모든 기존 고객 사주 데이터 정확성 확인
- [ ] 신규 고객 등록 시 정확한 사주 계산 확인
- [ ] 프론트엔드 차트에서 올바른 사주 표시 확인
- [ ] 오행균형도 정확성 검증
- [ ] API 응답에서 정확한 사주 데이터 확인

### 🎯 성공 지표
- **정확도**: 모든 사주 계산 100% 정확
- **데이터 일관성**: DB-API-프론트엔드 모든 레이어에서 동일한 사주 표시
- **사용자 경험**: 정확한 사주 분석 정보 제공

## ⚠️ 주의사항

1. **데이터 백업 필수**: customers.db 반드시 백업 후 진행
2. **단계적 검증**: 각 단계마다 결과 확인 후 다음 단계 진행
3. **롤백 준비**: 문제 발생 시 백업 DB로 즉시 복구 가능하도록 준비
4. **테스트 케이스 확보**: 1971.11.17.04시 외 추가 검증 케이스 준비

---
**작성일**: 2025-01-03  
**우선순위**: 🔥 긴급 (사주 정확도는 앱의 핵심 가치)  
**예상 소요시간**: 35분  
**담당**: Backend + Frontend 통합 검증 필요
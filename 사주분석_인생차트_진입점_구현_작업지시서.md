# 사주분석 인생차트 진입점 구현 작업지시서

## 📋 작업 개요

**목표**: 사주분석 페이지 상단에 인생차트 바로가기 버튼을 추가하고, 고객 데이터와 연동하여 원클릭으로 100년 인생운세 차트에 접근할 수 있도록 구현

**현재 상태**: 
- ✅ HundredYearChart 컴포넌트 구현 완료
- ✅ lifetimeFortuneApi 서비스 구현 완료
- ✅ 고객 데이터 API (customerApi.ts) 구현 완료
- ❌ 인생차트 진입점 UI 미구현
- ❌ 고객 데이터와 차트 데이터 자동 연동 미구현

## 🎯 작업 목표

1. **인생차트 진입점 UI 구현**
2. **고객 선택 시 자동 차트 데이터 연동**
3. **사주분석 결과와 인생차트 데이터 통합 표시**
4. **원클릭 차트 접근 기능 구현**

## 📁 관련 파일 위치

### 기존 구현 파일
- **사주분석 페이지**: `packages/web/src/pages/SajuAnalysisPage.tsx`
- **인생차트 컴포넌트**: `packages/web/src/components/Charts/HundredYearChart.tsx`
- **고객 API**: `packages/web/src/services/customerApi.ts`
- **인생운세 API**: `packages/web/src/services/lifetimeFortuneApi.ts`
- **고객 타입 정의**: `packages/web/src/services/customerApi.ts:6-18`

### 신규 생성 파일
- **인생차트 버튼 컴포넌트**: `packages/web/src/components/saju/LifeChartButton.tsx`
- **고객 데이터 변환 유틸**: `packages/web/src/utils/customerDataConverter.ts`

## 🔧 상세 작업 내용

### 1단계: 인생차트 진입점 UI 설계

**위치 결정:**
```typescript
// SajuAnalysisPage.tsx 구조 분석
<div className="space-y-8">
  {/* 🔥 신규 추가: 인생차트 진입점 */}
  <LifeChartSection 
    customer={currentUser}
    birthInfo={birthInfo}
    lifetimeFortune={lifetimeFortune}
    onChartLoad={handleLifeChartLoad}
  />
  
  {/* 기존: 100년 인생운세 차트 - 최상단 배치 */}
  {lifetimeFortune && (
    <div className="mb-12">
      <HundredYearChart ... />
    </div>
  )}
  
  {/* 기존: 다른 차트들 */}
  <FiveElementsBalanceChart ... />
  <TenGodsDistributionChart ... />
</div>
```

**버튼 디자인 스펙:**
```typescript
interface LifeChartButtonProps {
  customer?: Customer | UserProfile | null
  birthInfo?: SajuBirthInfo | null
  lifetimeFortune?: LifetimeFortuneResponse | null
  loading?: boolean
  onClick: () => void
}

// UI 디자인
- 위치: 사주분석 결과 최상단, HundredYearChart 바로 위
- 크기: 전체 너비, 높이 80px
- 색상: 그라데이션 배경 (보라-파랑)
- 아이콘: 📈 또는 ⭐
- 텍스트: "100년 인생운세 차트 보기"
- 상태 표시: 로딩/완료/오류 상태별 UI
```

### 2단계: 고객 데이터 연동 구조 설계

**데이터 흐름:**
```typescript
// 1. 고객 선택 시 자동 트리거
handleUserSelect(user: UserProfile) -> {
  // 기존 로직
  setCurrentUser(user)
  setBirthInfo(user.birthInfo)
  analyzeSaju(user.birthInfo)
  
  // 🔥 신규 추가: 인생차트 데이터 자동 로드
  loadLifeChartData(user.birthInfo)
}

// 2. 고객 데이터 -> 사주 API 요청 형식 변환
Customer -> LifetimeFortuneRequest
{
  id: 1,
  name: "홍길동",
  birth_date: "1988-03-15",     // -> year: 1988, month: 3, day: 15
  birth_time: "14:30",          // -> hour: 14
  lunar_solar: "solar",         // -> isLunar: false
  gender: "male"                // -> gender: "male"
}
```

**변환 로직 구현:**
```typescript
// utils/customerDataConverter.ts
export function convertCustomerToLifetimeRequest(
  customer: Customer
): LifetimeFortuneRequest {
  const birthDate = new Date(customer.birth_date)
  const [hour, minute] = customer.birth_time.split(':')
  
  return {
    year: birthDate.getFullYear(),
    month: birthDate.getMonth() + 1,
    day: birthDate.getDate(),
    hour: parseInt(hour),
    isLunar: customer.lunar_solar === 'lunar',
    gender: customer.gender
  }
}
```

### 3단계: 인생차트 버튼 컴포넌트 구현

**LifeChartButton.tsx 스펙:**
```typescript
interface LifeChartButtonProps {
  customer?: Customer | null
  lifetimeFortune?: LifetimeFortuneResponse | null
  loading: boolean
  onLoadChart: () => Promise<void>
}

// 기능 요구사항
1. 고객 정보 표시 (이름, 생년월일)
2. 차트 로드 상태 표시 (로딩/완료/오류)
3. 클릭 시 인생차트 데이터 로드
4. 로드 완료 시 차트 영역으로 스크롤
5. 반응형 디자인 (모바일/태블릿 대응)
```

**상태별 UI 디자인:**
```typescript
// 상태 1: 고객 미선택
<div className="bg-gray-100 border-2 border-dashed">
  <p>고객을 선택하면 100년 인생운세 차트를 확인할 수 있습니다</p>
</div>

// 상태 2: 로딩 중
<div className="bg-gradient-to-r from-purple-500 to-blue-500">
  <div className="animate-spin">⭐</div>
  <p>홍길동님의 100년 운세를 계산하고 있습니다...</p>
</div>

// 상태 3: 로드 완료
<div className="bg-gradient-to-r from-green-500 to-blue-500">
  <p>📈 홍길동님의 100년 인생운세 차트</p>
  <span className="text-sm">클릭하여 상세 차트 보기</span>
</div>

// 상태 4: 오류 발생
<div className="bg-gradient-to-r from-red-500 to-orange-500">
  <p>❌ 차트 로드 실패 - 다시 시도하세요</p>
</div>
```

### 4단계: SajuAnalysisPage 통합 구현

**기존 코드 수정 사항:**
```typescript
// 1. 인생차트 상태 관리 강화
const [lifeChartLoading, setLifeChartLoading] = useState(false)
const [lifeChartError, setLifeChartError] = useState<string | null>(null)

// 2. 고객 선택 시 자동 차트 로드
const handleUserSelect = async (user: UserProfile) => {
  // ... 기존 로직
  
  // 인생차트 자동 로드
  await loadLifeChartForUser(user)
}

// 3. 인생차트 로드 함수
const loadLifeChartForUser = async (user: UserProfile | Customer) => {
  try {
    setLifeChartLoading(true)
    setLifeChartError(null)
    
    const request = convertUserToLifetimeRequest(user)
    const response = await fetchLifetimeFortune(request)
    
    setLifetimeFortune(response)
    console.log('✅ 인생차트 로드 완료:', user.name)
    
  } catch (error) {
    setLifeChartError(error.message)
    console.error('❌ 인생차트 로드 실패:', error)
  } finally {
    setLifeChartLoading(false)
  }
}

// 4. 차트 영역 스크롤 함수
const scrollToChart = () => {
  document.getElementById('hundred-year-chart')?.scrollIntoView({
    behavior: 'smooth'
  })
}
```

**렌더링 구조 수정:**
```typescript
{analysisResult ? (
  <div className="space-y-8">
    {/* 🔥 신규: 인생차트 진입점 */}
    <LifeChartButton
      customer={currentUser}
      lifetimeFortune={lifetimeFortune}
      loading={lifeChartLoading}
      error={lifeChartError}
      onLoadChart={() => loadLifeChartForUser(currentUser)}
      onScrollToChart={scrollToChart}
    />

    {/* 기존: 100년 인생운세 차트 */}
    {lifetimeFortune && (
      <div id="hundred-year-chart" className="mb-12">
        <HundredYearChart
          data={lifetimeFortune.data.lifetimeFortune}
          currentAge={birthInfo ? calculateCurrentAge(birthInfo.year) : undefined}
        />
      </div>
    )}

    {/* 기존: 다른 차트들 */}
    <FiveElementsBalanceChart ... />
    <TenGodsDistributionChart ... />
  </div>
) : (
  // ... 분석 전 상태
)}
```

### 5단계: 고급 기능 구현

**5.1 차트 데이터 캐싱**
```typescript
// 고객별 차트 데이터 캐시
const lifeChartCache = new Map<string, LifetimeFortuneResponse>()

const getCacheKey = (user: UserProfile | Customer): string => {
  return `${user.birth_date}-${user.birth_time}-${user.gender}`
}

const loadLifeChartWithCache = async (user: UserProfile | Customer) => {
  const cacheKey = getCacheKey(user)
  
  // 캐시 확인
  if (lifeChartCache.has(cacheKey)) {
    setLifetimeFortune(lifeChartCache.get(cacheKey))
    return
  }
  
  // API 호출 및 캐시 저장
  const response = await fetchLifetimeFortune(request)
  lifeChartCache.set(cacheKey, response)
  setLifetimeFortune(response)
}
```

**5.2 키보드 단축키**
```typescript
// 키보드 단축키 지원 (Ctrl+L: 인생차트 로드)
useEffect(() => {
  const handleKeyPress = (e: KeyboardEvent) => {
    if (e.ctrlKey && e.key === 'l' && currentUser) {
      e.preventDefault()
      loadLifeChartForUser(currentUser)
    }
  }
  
  document.addEventListener('keydown', handleKeyPress)
  return () => document.removeEventListener('keydown', handleKeyPress)
}, [currentUser])
```

**5.3 차트 미리보기**
```typescript
// 버튼 호버 시 차트 요약 정보 표시
<div className="tooltip">
  <p>최고운세: {lifetimeFortune?.data.analysis.bestYear.age}세 ({lifetimeFortune?.data.analysis.bestYear.score}점)</p>
  <p>평균점수: {lifetimeFortune?.data.analysis.averageScore.toFixed(1)}점</p>
</div>
```

## 🔄 개발 워크플로우

### 단계별 구현 순서
```bash
# 1단계: 유틸리티 함수 구현
touch packages/web/src/utils/customerDataConverter.ts

# 2단계: 인생차트 버튼 컴포넌트 구현
touch packages/web/src/components/saju/LifeChartButton.tsx

# 3단계: SajuAnalysisPage 수정
# packages/web/src/pages/SajuAnalysisPage.tsx 수정

# 4단계: 스타일링 및 반응형 처리
# tailwind 클래스 추가 및 모바일 최적화

# 5단계: 테스트 및 디버깅
npm run dev
# http://localhost:4000 접속하여 테스트
```

### 테스트 시나리오
1. **고객 미선택 상태 테스트**
   - 사주분석 페이지 진입
   - 인생차트 버튼이 비활성 상태로 표시되는지 확인

2. **고객 선택 시 자동 로드 테스트**
   - 고객 선택
   - 인생차트 데이터 자동 로드 확인
   - 로딩 상태 UI 표시 확인

3. **차트 표시 및 스크롤 테스트**
   - 인생차트 버튼 클릭
   - 차트 영역으로 부드러운 스크롤 확인
   - 차트 데이터 정확한 표시 확인

4. **오류 처리 테스트**
   - 네트워크 오류 상황 시뮬레이션
   - 오류 메시지 표시 확인
   - 재시도 기능 동작 확인

## 📊 성공 기준

### 기능적 요구사항
- [ ] 사주분석 페이지에 인생차트 진입점 버튼 표시
- [ ] 고객 선택 시 자동으로 인생차트 데이터 로드
- [ ] 원클릭으로 100년 인생운세 차트 접근 가능
- [ ] 로딩/완료/오류 상태별 적절한 UI 표시
- [ ] 차트 영역으로 부드러운 스크롤 이동

### 비기능적 요구사항
- [ ] 반응형 디자인 (모바일/태블릿/데스크톱)
- [ ] 접근성 준수 (키보드 네비게이션, 스크린 리더)
- [ ] 성능 최적화 (차트 데이터 캐싱)
- [ ] 오류 핸들링 완비
- [ ] 로딩 상태 UX 개선

### UI/UX 요구사항
- [ ] 직관적인 버튼 디자인
- [ ] 명확한 상태 표시
- [ ] 매끄러운 애니메이션
- [ ] 일관된 디자인 시스템
- [ ] 사용자 피드백 제공

## ⚡ 우선순위 작업

### 최우선 (즉시 수행)
1. **고객 데이터 변환 유틸리티 구현**
2. **인생차트 버튼 컴포넌트 기본 구현**

### 차순위 (기본 기능 완성)
3. **SajuAnalysisPage 통합 및 자동 로드 구현**
4. **상태별 UI 및 오류 처리 구현**

### 후순위 (고급 기능)
5. **캐싱 시스템 및 성능 최적화**
6. **키보드 단축키 및 접근성 개선**

## 🚨 주의사항

### 데이터 변환 정확성
```typescript
// Customer 타입과 LifetimeFortuneRequest 타입 간 정확한 매핑 필수
Customer.birth_date: "1988-03-15" 
-> LifetimeFortuneRequest: { year: 1988, month: 3, day: 15 }

Customer.birth_time: "14:30"
-> LifetimeFortuneRequest: { hour: 14 } // 분 단위는 무시

Customer.lunar_solar: "lunar" | "solar"
-> LifetimeFortuneRequest: { isLunar: boolean }
```

### 상태 관리 일관성
```typescript
// 여러 상태가 동시에 관리되므로 일관성 유지 필요
- currentUser (고객 정보)
- lifetimeFortune (차트 데이터)
- lifeChartLoading (로딩 상태)
- lifeChartError (오류 상태)

// 상태 변경 시 모든 관련 상태 함께 업데이트
const resetLifeChartState = () => {
  setLifetimeFortune(null)
  setLifeChartLoading(false)
  setLifeChartError(null)
}
```

### 성능 고려사항
```typescript
// 100년 데이터는 용량이 크므로 불필요한 재계산 방지
- 동일한 고객에 대한 중복 API 호출 방지
- 컴포넌트 리렌더링 최적화 (React.memo 활용)
- 차트 데이터 메모이제이션
```

## 📝 완료 후 확인사항

### 최종 테스트 체크리스트
- [ ] 다양한 고객 데이터로 테스트 완료
- [ ] 모든 브라우저에서 정상 동작 확인
- [ ] 모바일/태블릿 반응형 테스트 완료
- [ ] 네트워크 오류 상황 테스트 완료
- [ ] 접근성 테스트 완료 (키보드, 스크린 리더)

### 문서화 완료
- [ ] 컴포넌트 props 타입 문서화
- [ ] 함수별 JSDoc 주석 추가
- [ ] 사용법 가이드 작성
- [ ] 트러블슈팅 가이드 작성

### 성공 시 보고 형식
```
✅ 사주분석 인생차트 진입점 구현 완료

🎯 구현된 기능:
- 인생차트 진입점 버튼 UI 구현
- 고객 선택 시 자동 차트 데이터 연동
- 원클릭 차트 접근 및 스크롤 이동
- 상태별 UI 및 오류 처리 완비

📱 지원 환경:
- 데스크톱 (Chrome, Firefox, Safari, Edge)
- 태블릿 (iPad, Android Tablet)
- 모바일 (iOS Safari, Chrome Mobile)

🔧 기술 스펙:
- React 컴포넌트 기반 구현
- TypeScript 타입 안전성 보장
- Tailwind CSS 반응형 스타일링
- 고객 데이터 자동 변환 및 캐싱

다음 단계: 추가 차트 시스템 구현 (17대 운세, 연간 운세 등)
```

---

**작성일**: 2025년 9월 11일  
**담당자**: Claude Code  
**예상 소요시간**: 3-4시간  
**우선순위**: 🔥 높음 (사용자 경험 개선)
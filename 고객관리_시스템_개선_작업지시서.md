# 고객관리 시스템 개선 작업지시서

## 📋 작업 개요
- **작성일**: 2025-09-16
- **우선순위**: 🔴 높음
- **예상 소요시간**: 3-4시간
- **관련 이슈**: 고객관리 새고객등록 기능 비정상 작동, 사주분석 메뉴 UI 개선 필요

## 🔍 현재 문제점 분석

### 1. 설정 페이지 고객관리 탭 문제
**위치**: `packages/web/src/pages/SettingsPage.tsx`
- **문제**: 고객관리 탭에서 새고객등록 기능이 정확히 작동하지 않음
- **원인 추정**:
  - 설정 페이지와 고객관리 페이지 간 라우팅 문제
  - 컴포넌트 상태 관리 불일치
  - 폼 검증 로직 오류

### 2. 사주분석 페이지 UI 문제
**위치**: `packages/web/src/pages/SajuAnalysisPage.tsx`
- **문제**: 고객선택 메뉴 옆에 새고객 등록 버튼 부재
- **현재 구조**:
  - UserSelectionPanel 컴포넌트 사용 중 (자체 사용자 시스템)
  - CustomerSelector 컴포넌트는 별도로 존재하나 통합되지 않음
- **개선 필요사항**: 고객 선택과 새고객 등록을 한 곳에서 처리

### 3. 데이터 흐름 문제
- **CustomerManagementPage**: 독립적으로 작동 (정상)
- **CustomerSelector**: 고객 선택만 가능 (등록 기능 없음)
- **설정 페이지 고객관리 탭**: CustomerManagementPage와 연동 미흡

## 🎯 개선 목표

### 1단계: CustomerSelector 컴포넌트 개선
- 고객 선택 드롭다운에 "➕ 새 고객 등록" 버튼 추가
- 새고객 등록 모달 통합
- 등록 후 자동 선택 기능

### 2단계: 설정 페이지 고객관리 탭 수정
- CustomerManagementPage 컴포넌트 직접 임베드
- 또는 라우팅으로 고객관리 페이지로 이동
- 탭 내에서 완전한 CRUD 기능 제공

### 3단계: 사주분석 페이지 UI 개선
- CustomerSelector를 메인 선택 도구로 변경
- UserSelectionPanel 대신 CustomerSelector 사용
- 고객 데이터를 사주 분석 입력으로 자동 변환

## 📝 구현 계획

### 1. CustomerSelector 컴포넌트 확장
```typescript
// packages/web/src/components/saju/CustomerSelector.tsx 수정

interface CustomerSelectorProps {
  onSelect: (customer: Customer | null) => void;
  selectedCustomer: Customer | null;
  showAddButton?: boolean; // 새 속성 추가
}

// 컴포넌트 내부에 새고객 등록 모달 추가
const [showAddModal, setShowAddModal] = useState(false);

// 드롭다운에 새고객 등록 버튼 추가
<div className="p-2 border-b dark:border-gray-700">
  <button
    onClick={() => setShowAddModal(true)}
    className="w-full px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
  >
    ➕ 새 고객 등록
  </button>
</div>

// 새고객 등록 모달 컴포넌트
{showAddModal && (
  <CustomerAddModal
    onClose={() => setShowAddModal(false)}
    onSuccess={(newCustomer) => {
      handleSelect(newCustomer);
      setShowAddModal(false);
      loadCustomers(); // 목록 새로고침
    }}
  />
)}
```

### 2. CustomerAddModal 컴포넌트 생성
```typescript
// packages/web/src/components/saju/CustomerAddModal.tsx (새 파일)

import { useState } from 'react';
import { createCustomer, Customer } from '@/services/customerApi';

interface CustomerAddModalProps {
  onClose: () => void;
  onSuccess: (customer: Customer) => void;
}

export default function CustomerAddModal({ onClose, onSuccess }: CustomerAddModalProps) {
  // 폼 상태 관리
  // 유효성 검증
  // API 호출
  // 성공/실패 처리
}
```

### 3. SajuAnalysisPage 수정
```typescript
// packages/web/src/pages/SajuAnalysisPage.tsx 수정

import CustomerSelector from '@/components/saju/CustomerSelector';

// UserSelectionPanel 대신 CustomerSelector 사용
<div className="space-y-4">
  <CustomerSelector
    selectedCustomer={selectedCustomer}
    onSelect={handleCustomerSelect}
    showAddButton={true}
  />
</div>

// 고객 선택 핸들러
const handleCustomerSelect = (customer: Customer | null) => {
  if (customer) {
    // Customer 데이터를 SajuBirthInfo로 변환
    const birthInfo: SajuBirthInfo = {
      year: parseInt(customer.birth_date.split('-')[0]),
      month: parseInt(customer.birth_date.split('-')[1]),
      day: parseInt(customer.birth_date.split('-')[2]),
      hour: parseInt(customer.birth_time.split(':')[0]),
      minute: parseInt(customer.birth_time.split(':')[1] || '0'),
      isLunar: customer.lunar_solar === 'lunar',
      gender: customer.gender,
    };
    setBirthInfo(birthInfo);
    analyzeSaju(birthInfo);
  }
};
```

### 4. 설정 페이지 고객관리 탭 개선
```typescript
// packages/web/src/pages/SettingsPage.tsx 수정

import CustomerManagementPage from './CustomerManagementPage';

// 고객관리 탭 내용
{activeTab === 'customers' && (
  <div className="space-y-6">
    <div className="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
      <p className="text-yellow-800 dark:text-yellow-200">
        💡 고객 정보를 관리하고 사주 분석에 활용할 수 있습니다.
      </p>
    </div>
    <CustomerManagementPage embedded={true} />
  </div>
)}
```

### 5. CustomerManagementPage 임베드 모드 지원
```typescript
// packages/web/src/pages/CustomerManagementPage.tsx 수정

interface CustomerManagementPageProps {
  embedded?: boolean; // 설정 페이지 내 임베드 여부
}

export default function CustomerManagementPage({ embedded = false }: CustomerManagementPageProps) {
  // embedded 모드일 때 레이아웃 조정
  const containerClass = embedded
    ? "bg-white dark:bg-gray-800 rounded-lg p-6"
    : "min-h-screen bg-gray-50 dark:bg-gray-900 p-6";

  return (
    <div className={containerClass}>
      {/* 기존 컨텐츠 */}
    </div>
  );
}
```

## 🧪 테스트 시나리오

### 시나리오 1: 사주분석 페이지에서 새고객 등록
1. 사주분석 페이지 접속
2. 고객 선택 드롭다운 클릭
3. "➕ 새 고객 등록" 버튼 클릭
4. 고객 정보 입력 후 저장
5. 자동으로 해당 고객 선택되고 사주 분석 시작

### 시나리오 2: 설정 페이지 고객관리 탭
1. 설정 페이지 > 고객관리 탭 이동
2. 고객 목록 확인
3. 새 고객 등록 버튼 클릭
4. 정보 입력 및 저장
5. 목록에 즉시 반영 확인

### 시나리오 3: 고객 데이터 동기화
1. 고객관리에서 고객 정보 수정
2. 사주분석 페이지에서 해당 고객 선택
3. 수정된 정보가 반영되어 있는지 확인

## 🔧 기술적 고려사항

### API 통신
- Calendar Service (포트 5001)의 `/api/calendar/customers` 엔드포인트 활용
- 에러 처리 및 로딩 상태 관리
- 낙관적 업데이트 적용

### 상태 관리
- 고객 목록 캐싱 전략
- 선택된 고객 정보 전역 상태 관리 고려
- React Query 도입 검토

### UI/UX
- 모달 접근성 (키보드 네비게이션, ESC 닫기)
- 폼 유효성 검증 실시간 피드백
- 로딩 및 에러 상태 시각화
- 모바일 반응형 디자인

### 데이터 변환
- Customer ↔ SajuBirthInfo 변환 유틸리티 함수
- 음력/양력 변환 처리
- 시간 형식 통일 (24시간제)

## 📊 완료 기준

### 필수 요구사항
- [ ] CustomerSelector에 새고객 등록 버튼 및 모달 추가
- [ ] 사주분석 페이지에서 고객 선택 및 등록 가능
- [ ] 설정 페이지 고객관리 탭에서 완전한 CRUD 기능
- [ ] 등록된 고객 정보로 사주 분석 자동 실행
- [ ] 모든 페이지에서 고객 데이터 동기화

### 품질 기준
- [ ] TypeScript 타입 에러 없음
- [ ] ESLint 경고/에러 해결
- [ ] 3가지 테스트 시나리오 통과
- [ ] 브라우저 콘솔 에러 없음
- [ ] 모바일 반응형 UI 정상 작동

## 🚀 실행 명령어

### 개발 서버 실행
```bash
# 프론트엔드 (포트 4000)
cd packages/web && npm run dev

# Calendar Service (포트 5001) - 고객 데이터 API
cd packages/backend/services/calendar && npm run dev
```

### 테스트
```bash
# 브라우저에서 테스트
1. http://localhost:4000/settings (설정 페이지 고객관리 탭)
2. http://localhost:4000/saju (사주분석 페이지)
3. http://localhost:4000/customers (고객관리 전용 페이지)
```

## 📝 참고 문서
- Customer API: `packages/web/src/services/customerApi.ts`
- Customer 타입 정의: `packages/web/src/types/customer.ts`
- 사주 타입 정의: `packages/web/src/types/saju.ts`
- 기존 고객관리 페이지: `packages/web/src/pages/CustomerManagementPage.tsx`

## ⚠️ 주의사항

1. **데이터 무결성**
   - 고객 삭제 시 관련 분석 데이터 처리 방안 검토
   - 중복 고객 등록 방지 (이름+생년월일)

2. **성능 최적화**
   - 고객 목록이 많을 경우 페이지네이션 필수
   - 검색 디바운싱 적용 (300ms)

3. **보안 고려사항**
   - 개인정보 노출 최소화
   - XSS 방지를 위한 입력값 검증

4. **하위 호환성**
   - 기존 UserSelectionPanel 사용 부분과 충돌 방지
   - localStorage 데이터와 DB 데이터 동기화

---

*이 작업지시서는 고객관리 시스템의 통합성과 사용성을 개선하기 위한 종합적인 가이드입니다.*
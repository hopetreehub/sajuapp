# 100년 인생운세 백엔드 API 구현 작업지시서

## 📋 작업 개요

**목표**: 프론트엔드에서 호출하는 100년 인생운세 API를 완전히 구현하여 차트가 정상 표시되도록 함

**현재 상태**: 
- ✅ 프론트엔드 차트 컴포넌트 구현 완료
- ✅ API 호출 서비스 구현 완료  
- ❌ 백엔드 API 서버 TypeScript 오류로 실행 불가
- ❌ 따라서 100년 인생운세 차트가 표시되지 않음

## 🎯 작업 목표

1. **백엔드 TypeScript 오류 수정**
2. **포트 4015 사주 분석 서비스 정상 실행**
3. **100년 인생운세 API 엔드포인트 동작 확인**
4. **프론트엔드-백엔드 연동 테스트 완료**

## 📁 관련 파일 위치

### 프론트엔드 (정상 동작)
- **차트 컴포넌트**: `packages/web/src/components/charts/HundredYearChart.tsx`
- **API 호출**: `packages/web/src/services/lifetimeFortuneApi.ts`  
- **사용 페이지**: `packages/web/src/pages/SajuAnalysisPage.tsx:337-345`

### 백엔드 (수정 필요)
- **메인 서버**: `packages/backend/services/saju-analysis/src/index.ts`
- **API 엔드포인트**: `Line 1072 - POST /api/saju/lifetime-fortune`
- **계산 엔진**: `packages/backend/services/saju-analysis/src/services/LifetimeFortuneCalculator.ts`

## 🔧 상세 작업 내용

### 1단계: TypeScript 오류 분석 및 수정

**현재 오류 유형**:
```typescript
// 주요 오류 패턴들:
- error TS18046: 'row' is of type 'unknown'
- error TS7053: Element implicitly has an 'any' type
- error TS2339: Property does not exist on type '{}'
```

**수정 작업**:
1. SQLite 쿼리 결과 타입 정의 추가
2. 인덱스 시그니처 타입 안전성 개선
3. any 타입 사용 최소화

### 2단계: 100년 인생운세 API 구현 검증

**API 스펙 확인**:
```typescript
// 요청 형식
POST http://localhost:4015/api/saju/lifetime-fortune
{
  "year": 1988,
  "month": 3, 
  "day": 15,
  "hour": 14,
  "isLunar": false,
  "gender": "male"
}

// 응답 형식  
{
  "success": true,
  "data": {
    "lifetimeFortune": YearlyFortune[],
    "analysis": {
      "keyYears": YearlyFortune[],
      "bestYear": {...},
      "worstYear": {...},
      "averageScore": number
    }
  },
  "timestamp": string
}
```

**YearlyFortune 인터페이스**:
```typescript
interface YearlyFortune {
  year: number
  age: number
  totalScore: number      // 종합 운세 점수 (0-100)
  fortune: number        // 행운 (재물, 명예, 성공운)
  willpower: number      // 의지 (노력, 추진력, 실행력)
  environment: number    // 환경 (대인관계, 외부 지원)
  change: number         // 변화 (변동성, 기회, 위기)
  대운: {
    천간: string
    지지: string
    오행: string
    score: number
  }
  세운: {
    천간: string
    지지: string
    오행: string
    score: number
  }
}
```

### 3단계: 서버 실행 및 테스트

**실행 순서**:
1. TypeScript 오류 수정
2. 빌드 성공 확인: `npm run build`
3. 서버 실행: `npx ts-node src/index.ts` 또는 빌드된 파일 실행
4. API 테스트: `curl -X POST http://localhost:4015/api/saju/lifetime-fortune`

**테스트 케이스**:
```bash
# 기본 테스트
curl -X POST http://localhost:4015/api/saju/lifetime-fortune \
  -H "Content-Type: application/json" \
  -d '{
    "year": 1988,
    "month": 3,
    "day": 15, 
    "hour": 14,
    "isLunar": false,
    "gender": "male"
  }'

# 여성 테스트  
curl -X POST http://localhost:4015/api/saju/lifetime-fortune \
  -H "Content-Type: application/json" \
  -d '{
    "year": 1995,
    "month": 8,
    "day": 22,
    "hour": 10,
    "isLunar": false, 
    "gender": "female"
  }'
```

### 4단계: 프론트엔드 연동 테스트

**테스트 절차**:
1. http://localhost:4000 접속
2. 사주 분석 페이지 이동
3. 생년월일시 입력 후 분석 실행
4. **100년 인생운세 차트가 페이지 최상단에 표시**되는지 확인
5. 차트의 4가지 선(행운/의지/환경/변화) 정상 표시 확인
6. 현재 나이 빨간 수직선 표시 확인

## 🚨 주의사항

### TypeScript 엄격 모드 대응
```typescript
// 현재 문제가 되는 패턴들을 다음과 같이 수정:

// 문제: row is of type 'unknown'
db.get(query, (err, row) => {
  if (row) {
    const data = row.some_field  // 오류
  }
})

// 해결: 타입 단언 또는 인터페이스 정의
interface RowData {
  some_field: string
}

db.get(query, (err, row: RowData | undefined) => {
  if (row) {
    const data = row.some_field  // OK
  }
})
```

### 인덱스 시그니처 문제 해결
```typescript
// 문제: No index signature with a parameter of type 'string'
const elementMap = { wood: '木', fire: '火' }
const result = elementMap[someString]  // 오류

// 해결1: 타입 단언  
const result = elementMap[someString as keyof typeof elementMap]

// 해결2: 인덱스 시그니처 추가
interface ElementMap {
  [key: string]: string
  wood: string
  fire: string
}
```

## 📊 성공 기준

### 백엔드 성공 기준
- [ ] TypeScript 컴파일 오류 0개
- [ ] 서버 정상 실행 (포트 4015)
- [ ] API 엔드포인트 응답 성공 (200 OK)
- [ ] 100년 데이터 정확한 생성 (1년~100년)
- [ ] 대운/세운 계산 정확성

### 프론트엔드 연동 성공 기준  
- [ ] 차트 컴포넌트 정상 렌더링
- [ ] 4가지 기운 선 그래프 표시
- [ ] 막대 그래프 (종합 운세) 표시
- [ ] 현재 나이 표시선 표시
- [ ] 툴팁 정보 정확한 표시
- [ ] 반응형 레이아웃 동작

## ⚡ 우선순위 작업

### 최우선 (즉시 수행)
1. **TypeScript 오류 수정** - SQLite 타입 정의
2. **서버 실행 성공** - 포트 4015 동작 확인

### 차순위 (연동 테스트)
3. **API 응답 검증** - 데이터 구조 정확성
4. **프론트엔드 테스트** - 차트 표시 확인

### 추후 개선사항
5. **성능 최적화** - 대용량 데이터 처리
6. **캐싱 시스템** - 계산 결과 저장
7. **에러 핸들링** - 예외 상황 대응

## 🔄 개발 워크플로우

### 개발 환경 설정
```bash
# 백엔드 작업 디렉토리
cd packages/backend/services/saju-analysis

# 의존성 확인
npm install

# TypeScript 컴파일 테스트
npx tsc --noEmit

# 실제 빌드
npm run build

# 서버 실행 테스트
npx ts-node src/index.ts
```

### 병렬 작업 체크
```bash
# 터미널 1: 프론트엔드 (이미 실행 중)
cd packages/web && npm run dev  # 포트 4000

# 터미널 2: API 게이트웨이 (이미 실행 중)  
cd packages/backend/api-gateway && node dist/index.js  # 포트 4012

# 터미널 3: 사주 분석 서비스 (구현 필요)
cd packages/backend/services/saju-analysis && npx ts-node src/index.ts  # 포트 4015
```

## 📝 완료 후 확인사항

### 최종 테스트 체크리스트
- [ ] 백엔드 서버 3개 모두 정상 실행
- [ ] API 호출 성공 (lifetimeFortuneApi.ts)
- [ ] 브라우저에서 100년 차트 표시 확인
- [ ] 다양한 생년월일 입력 테스트
- [ ] 차트 인터랙션 (호버, 클릭) 동작 확인
- [ ] 모바일/태블릿 반응형 확인

### 문제 해결 가이드
**만약 여전히 차트가 보이지 않는다면:**
1. 브라우저 개발자 도구 > Console 탭에서 에러 확인
2. Network 탭에서 API 호출 실패 여부 확인
3. lifetimeFortune 데이터 null 여부 확인

**성공 시 보고 형식:**
```
✅ 100년 인생운세 백엔드 API 구현 완료

- 백엔드 서버 정상 실행: 포트 4015
- API 엔드포인트 동작 확인: POST /api/saju/lifetime-fortune
- 프론트엔드 차트 표시 성공: HundredYearChart.tsx
- 테스트 완료: 여러 생년월일 케이스 검증

다음 단계: 추가 차트 시스템 구현 (6대 영역, 17대 운세 등)
```

---

**작성일**: 2025년 9월 11일  
**담당자**: Claude Code  
**예상 소요시간**: 2-3시간  
**우선순위**: 🔥 긴급 (사용자 대기 중)**
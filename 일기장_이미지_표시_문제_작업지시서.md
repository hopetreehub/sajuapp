# 📋 일기장 이미지 표시 문제 해결 작업지시서

## 🐛 문제 현상
- **상태**: 일기장에 이미지가 저장은 되지만 다른 화면으로 갔다가 돌아오면 이미지가 표시되지 않음
- **증상**: 
  - 일기 작성 시 이미지 업로드 및 저장 ✅ 성공
  - 일기장을 닫았다가 다시 열면 이미지 미표시 ❌
  - 페이지 새로고침 또는 다른 날짜 이동 후 돌아와도 이미지 없음

## 🔍 예상 원인 분석

### 1. 백엔드 API 문제
- [ ] 일기 조회 API가 images 필드를 제대로 반환하지 않음
- [ ] 데이터베이스에서 images 데이터 조회 로직 누락
- [ ] JSON 파싱 문제 (images는 JSON 문자열로 저장됨)

### 2. 프론트엔드 렌더링 문제  
- [ ] DiaryBookModal에서 일기 데이터 로드 시 images 필드 처리 누락
- [ ] 이미지 상태 초기화 문제
- [ ] useEffect에서 diary 데이터 변경 시 images 상태 업데이트 누락

## 📋 점검 체크리스트

### 1단계: 백엔드 API 검증
```typescript
// packages/backend/services/diary/src/services/diary.service.ts
// GET /api/diaries/:id 엔드포인트 확인
- images 필드가 SELECT 쿼리에 포함되어 있는지
- images 데이터 JSON.parse() 처리 여부
- API 응답에 images 배열 포함 여부
```

### 2단계: 데이터베이스 저장 확인
```sql
-- 실제 데이터베이스에서 images 컬럼 데이터 확인
SELECT id, date, images FROM diary_entries WHERE images IS NOT NULL;
```

### 3단계: 프론트엔드 데이터 로딩
```typescript
// packages/web/src/components/DiaryBookModal.tsx
// useEffect에서 diary 로드 시:
useEffect(() => {
  if (diary) {
    setContent(diary.content || '');
    setMood(diary.mood || '');
    setWeather(diary.weather || '');
    setTags(diary.tags || []);
    // ⚠️ 이 부분이 누락되었을 가능성
    setImages(diary.images || []); // <-- 확인 필요!
  }
}, [diary]);
```

## 🛠️ 수정 작업

### 1. 백엔드 서비스 수정
**파일**: `packages/backend/services/diary/src/services/diary.service.ts`

#### 1.1 일기 조회 시 images 필드 처리
```typescript
// getDiaryByDate 함수 수정
async getDiaryByDate(userId: string, date: string): Promise<DiaryEntry | null> {
  const diary = await db.get(
    'SELECT * FROM diary_entries WHERE user_id = ? AND date = ?',
    [userId, date]
  );
  
  if (diary && diary.images) {
    // JSON 문자열을 배열로 파싱
    diary.images = JSON.parse(diary.images);
  }
  
  return diary;
}
```

#### 1.2 일기 저장 시 images 필드 처리
```typescript
// createDiary 또는 updateDiary 함수에서
const imagesJson = entry.images ? JSON.stringify(entry.images) : null;
// INSERT/UPDATE 쿼리에 imagesJson 사용
```

### 2. 프론트엔드 컴포넌트 수정
**파일**: `packages/web/src/components/DiaryBookModal.tsx`

#### 2.1 일기 데이터 로드 시 이미지 상태 설정
```typescript
useEffect(() => {
  const loadDiary = async () => {
    if (selectedDate) {
      try {
        const entry = await getDiaryByDate(selectedDate);
        if (entry) {
          setDiary(entry);
          setContent(entry.content || '');
          setMood(entry.mood || '');
          setWeather(entry.weather || '');
          setTags(entry.tags || []);
          // ✅ 이미지 상태 설정 추가
          setImages(entry.images || []);
        } else {
          // 새 일기 작성 시 초기화
          resetForm();
        }
      } catch (error) {
        console.error('일기 로드 실패:', error);
      }
    }
  };
  
  loadDiary();
}, [selectedDate]);
```

#### 2.2 resetForm 함수에 이미지 초기화 추가
```typescript
const resetForm = () => {
  setContent('');
  setMood('');
  setWeather('');
  setTags([]);
  setImages([]); // ✅ 이미지 초기화 추가
};
```

## 🧪 테스트 시나리오

### 테스트 1: 이미지 저장 확인
1. 일기에 이미지 추가
2. 저장 버튼 클릭
3. 네트워크 탭에서 PUT/POST 요청 확인
4. Request payload에 images 배열 확인

### 테스트 2: 이미지 로드 확인
1. 일기장 닫기
2. 같은 날짜 다시 선택
3. 네트워크 탭에서 GET 요청 확인
4. Response에 images 배열 포함 여부 확인
5. 화면에 이미지 표시 여부 확인

### 테스트 3: 페이지 새로고침
1. 이미지가 있는 일기 열기
2. F5로 페이지 새로고침
3. 같은 날짜 일기 다시 열기
4. 이미지 표시 확인

## 📊 디버깅 로그 추가

### 백엔드 로깅
```typescript
logger.info('Fetching diary with images:', {
  userId,
  date,
  hasImages: !!diary.images,
  imageCount: diary.images?.length || 0
});
```

### 프론트엔드 로깅
```typescript
console.log('Diary loaded:', {
  date: selectedDate,
  hasImages: !!entry.images,
  imageCount: entry.images?.length || 0,
  images: entry.images
});
```

## ⚠️ 주의사항
1. **Base64 크기**: 이미지가 큰 경우 JSON 파싱 실패 가능성
2. **NULL 처리**: images가 null인 경우 안전한 처리 필요
3. **타입 안정성**: TypeScript 타입 정의 일치 확인

## 🎯 작업 우선순위
1. **긴급**: 백엔드 API 응답에 images 포함 확인
2. **높음**: 프론트엔드 useEffect 이미지 로드 수정
3. **중간**: 디버그 로그 추가 및 테스트

## 📝 예상 작업 시간
- 디버깅 및 원인 파악: 10분
- 코드 수정: 15분
- 테스트 및 검증: 10분
- **총 예상 시간**: 35분

---

**작업 완료 후 확인사항:**
- [ ] 이미지가 있는 일기 저장 후 다시 열어도 표시됨
- [ ] 페이지 새로고침 후에도 이미지 유지됨
- [ ] 다른 날짜 이동 후 돌아와도 이미지 표시됨
- [ ] 콘솔 에러 없음
/**
 * íƒ€ë¡œ(Tarot) AI ì±„íŒ… ë¼ìš°íŠ¸
 *
 * @author Claude Code
 * @version 2.0.0
 * @updated 2025-10-23 - ë§ˆí¬ë‹¤ìš´ ì œê±°, ì¼ë°˜ í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ë³€ê²½
 */

import { Router, Request, Response } from 'express';
import { v4 as uuidv4 } from 'uuid';
import { aiOrchestrator } from '@/services/ai-orchestrator.service';
import { AIRequest, AIRequestType } from '@/types/ai.types';
import { logger } from '@/utils/logger';

const router = Router();

/**
 * íƒ€ë¡œ AI ì±„íŒ… ì—”ë“œí¬ì¸íŠ¸
 * POST /api/v1/tarot/chat
 */
router.post('/chat', async (req: Request, res: Response) => {
  try {
    const { prompt, userQuestion, cardCount } = req.body;

    if (!prompt || !userQuestion) {
      return res.status(400).json({
        success: false,
        error: 'í”„ë¡¬í”„íŠ¸ì™€ ì‚¬ìš©ì ì§ˆë¬¸ì´ í•„ìš”í•©ë‹ˆë‹¤',
      });
    }

    // ì¹´ë“œ ìˆ˜ì— ë”°ë¼ maxTokens ë™ì  ì¡°ì • (ë‚´ìš© ì¶©ì‹¤ë„ í–¥ìƒ)
    // 1ì¥: 1200, 3ì¥: 1800, 5ì¥: 2500, 7ì¥: 3500, 10ì¥: 3500
    const calculatedMaxTokens = Math.min(
      3500,
      Math.max(1200, (cardCount || 3) * 500)
    );

    // AI Orchestratorë¥¼ í†µí•´ ìš”ì²­ ì²˜ë¦¬
    const aiRequest: AIRequest = {
      id: uuidv4(),
      requestType: AIRequestType.TAROT,
      systemPrompt: `ğŸš¨ğŸš¨ğŸš¨ CRITICAL LANGUAGE REQUIREMENT ğŸš¨ğŸš¨ğŸš¨
YOU MUST WRITE ONLY IN KOREAN (í•œêµ­ì–´)
DO NOT use Chinese (ä¸­æ–‡), Japanese (æ—¥æœ¬èª), English, or any other language
EVERY SINGLE WORD must be in Korean

ë‹¹ì‹ ì€ 30ë…„ ê²½ë ¥ì˜ ì „ë¬¸ íƒ€ë¡œ ë¦¬ë”ì…ë‹ˆë‹¤.

**âœ… í•„ìˆ˜ ì¤€ìˆ˜ì‚¬í•­:**
1. ëª¨ë“  ì‘ë‹µì€ 100% í•œêµ­ì–´ë¡œë§Œ ì‘ì„±
2. ì¤‘êµ­ì–´, ì¼ë³¸ì–´, ì˜ì–´ ë‹¨ì–´ ì‚¬ìš© ì ˆëŒ€ ê¸ˆì§€
3. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ì§ì ‘ì ìœ¼ë¡œ ë‹µë³€
4. ê¹”ë”í•œ í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì‘ì„± (ë§ˆí¬ë‹¤ìš´ ì‚¬ìš© ê¸ˆì§€)

**í•µì‹¬ ì›ì¹™:**
1. ì§ˆë¬¸ ì¤‘ì‹¬: ëª¨ë“  ì¹´ë“œë¥¼ ì§ˆë¬¸ì˜ ë§¥ë½ì—ì„œ í•´ì„
2. ì§ì ‘ì  íŒë‹¨: "ê¸ì •ì ì…ë‹ˆë‹¤", "ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤", "ì¤‘ë¦½ì ì…ë‹ˆë‹¤"
3. êµ¬ì²´ì  ì¡°ì–¸: "~í•˜ì„¸ìš”", "~í•˜ì§€ ë§ˆì„¸ìš”"
4. ì¶©ì‹¤í•œ ë‚´ìš©: ê° ì„¹ì…˜ì€ ì§€ì •ëœ ë¬¸ì¥ ìˆ˜ë§Œí¼ ì‘ì„±

**í…ìŠ¤íŠ¸ í¬ë§·íŒ… ê·œì¹™ (ë§ˆí¬ë‹¤ìš´ ì‚¬ìš© ê¸ˆì§€!):**

**1ì¥ ìŠ¤í”„ë ˆë“œ (ë‹¨ì¼ ì¹´ë“œ):**

=== íƒ€ë¡œ ë¦¬ë”© ê²°ê³¼ ===

ì‚¬ìš©ìë‹˜ì˜ ì§ˆë¬¸: [ì§ˆë¬¸ ë‚´ìš©ì„ ì—¬ê¸° í•œ ì¤„ë¡œ ìš”ì•½]


[ë½‘ì€ ì¹´ë“œ: ì¹´ë“œëª… - ì •/ì—­ë°©í–¥]

ê¸¸í‰: [ê¸ì •ì ì…ë‹ˆë‹¤ / ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤ / ì¤‘ë¦½ì ì…ë‹ˆë‹¤]

ì¹´ë“œì˜ ì˜ë¯¸:
[ì¹´ë“œê°€ ê°€ì§„ ê¸°ë³¸ ì˜ë¯¸ 3-4ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…]

ì§ˆë¬¸ì— ëŒ€í•œ í•´ì„:
[ì‚¬ìš©ì ì§ˆë¬¸ê³¼ ì—°ê²°ëœ êµ¬ì²´ì  í•´ì„ 4-5ë¬¸ì¥]

êµ¬ì²´ì  ì¡°ì–¸:
[ì§ˆë¬¸ì— ëŒ€í•œ ì‹¤ì²œ ê°€ëŠ¥í•œ í–‰ë™ ì§€ì¹¨ 4-5ë¬¸ì¥]


=== ì¢…í•© ì¡°ì–¸ ===

[ì‚¬ìš©ì ì§ˆë¬¸ì— ëŒ€í•œ ìµœì¢… ë‹µë³€ 5-6ë¬¸ì¥. ì¹´ë“œì˜ ë©”ì‹œì§€ë¥¼ ìš”ì•½í•˜ê³  êµ¬ì²´ì ì¸ í–‰ë™ ê³„íšì„ ì œì‹œ]

**3ì¥ ì´ìƒ ìŠ¤í”„ë ˆë“œ:**

=== íƒ€ë¡œ ë¦¬ë”© ê²°ê³¼ ===

ì‚¬ìš©ìë‹˜ì˜ ì§ˆë¬¸: [ì§ˆë¬¸ ë‚´ìš©ì„ ì—¬ê¸° í•œ ì¤„ë¡œ ìš”ì•½]


[1. ì¹´ë“œ ìœ„ì¹˜ (ì¹´ë“œëª… - ì •/ì—­ë°©í–¥)]

ê¸¸í‰: [ê¸ì •ì ì…ë‹ˆë‹¤ / ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤ / ì¤‘ë¦½ì ì…ë‹ˆë‹¤]

ì¹´ë“œì˜ ì˜ë¯¸:
[ì¹´ë“œê°€ ê°€ì§„ ê¸°ë³¸ ì˜ë¯¸ 2-3ë¬¸ì¥]

ì§ˆë¬¸ì— ëŒ€í•œ í•´ì„:
[ì‚¬ìš©ì ì§ˆë¬¸ê³¼ ì—°ê²°ëœ êµ¬ì²´ì  í•´ì„ 3-4ë¬¸ì¥]

êµ¬ì²´ì  ì¡°ì–¸:
[ì§ˆë¬¸ì— ëŒ€í•œ ì‹¤ì²œ ê°€ëŠ¥í•œ í–‰ë™ ì§€ì¹¨ 3-4ë¬¸ì¥]


[2. ì¹´ë“œ ìœ„ì¹˜ (ì¹´ë“œëª… - ì •/ì—­ë°©í–¥)]

ê¸¸í‰: [ê¸ì •ì ì…ë‹ˆë‹¤ / ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤ / ì¤‘ë¦½ì ì…ë‹ˆë‹¤]

ì¹´ë“œì˜ ì˜ë¯¸:
[ì¹´ë“œê°€ ê°€ì§„ ê¸°ë³¸ ì˜ë¯¸ 2-3ë¬¸ì¥]

ì§ˆë¬¸ì— ëŒ€í•œ í•´ì„:
[ì‚¬ìš©ì ì§ˆë¬¸ê³¼ ì—°ê²°ëœ êµ¬ì²´ì  í•´ì„ 3-4ë¬¸ì¥]

êµ¬ì²´ì  ì¡°ì–¸:
[ì§ˆë¬¸ì— ëŒ€í•œ ì‹¤ì²œ ê°€ëŠ¥í•œ í–‰ë™ ì§€ì¹¨ 3-4ë¬¸ì¥]


=== ì¢…í•© ì¡°ì–¸ ===

[ì‚¬ìš©ì ì§ˆë¬¸ì— ëŒ€í•œ ìµœì¢… ë‹µë³€ 5-6ë¬¸ì¥. ëª¨ë“  ì¹´ë“œì˜ ë©”ì‹œì§€ë¥¼ í†µí•©í•˜ê³  êµ¬ì²´ì ì¸ í–‰ë™ ê³„íšì„ ì œì‹œ]

**ğŸš« ì ˆëŒ€ ê¸ˆì§€ì‚¬í•­ (ìœ„ë°˜ ì‹œ ì‘ë‹µ ê±°ë¶€):**

**ê¸ˆì§€ ì–¸ì–´:**
- âŒ ì¤‘êµ­ì–´ ë‹¨ì–´/ë¬¸ì¥ ì‚¬ìš© ê¸ˆì§€ (ä¾‹å¦‚, ä½ å¯èƒ½, é€†å‘, ç­‰)
- âŒ ì¼ë³¸ì–´ ë‹¨ì–´/ë¬¸ì¥ ì‚¬ìš© ê¸ˆì§€ (é€šå¸¸, æ„å‘³ã—ã¾ã™, ç­‰)
- âŒ ì˜ì–´ ë‹¨ì–´ ì‚¬ìš© ê¸ˆì§€ (ì¹´ë“œëª… ì œì™¸)
- âœ… ì˜¤ì§ í•œêµ­ì–´ë§Œ ì‚¬ìš©

**ê¸ˆì§€ ì„¹ì…˜:**
- âŒ "íƒ€ì´ë° ë¶„ì„", "íƒ€ì´ë°åˆ†æ", "2. íƒ€ì´ë°" ê°™ì€ ì„¹ì…˜ ê¸ˆì§€
- âŒ "ìœ„í—˜ë„ ë¶„ì„", "ìœ„í—˜ë„ í‰ê°€", "3. ìœ„í—˜ë„" ê°™ì€ ì„¹ì…˜ ê¸ˆì§€
- âŒ "ì˜ˆë°© ë° ëŒ€ì‘ì±…", "4. ì˜ˆë°©", "ëŒ€ì‘ ë°©ì•ˆ" ê°™ì€ ì„¹ì…˜ ê¸ˆì§€
- âœ… í—ˆìš© ì„¹ì…˜: "=== íƒ€ë¡œ ë¦¬ë”© ê²°ê³¼ ===", "=== ì¢…í•© ì¡°ì–¸ ===" 2ê°œë§Œ

**ê¸ˆì§€ í‘œí˜„:**
- âŒ "1-2ê°œì›”", "ê°€ê¹Œìš´ ë¯¸ë˜", "ì´ë²ˆ ì£¼" ê°™ì€ ì‹œê°„ í‘œí˜„
- âŒ "ìœ„í—˜ë„ê°€ ë†’ìœ¼ë¯€ë¡œ", "ìœ„í—˜ ìˆ˜ì¤€ì€" ê°™ì€ ìœ„í—˜ë„ í‰ê°€
- âŒ ì¢…í•© ì¡°ì–¸ì— ìˆ«ì ë¦¬ìŠ¤íŠ¸(1., 2., 3.) ì‚¬ìš©
- âŒ ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸: ##, ###, **, *, -, >, ë“±

**ì‘ì„± ê·œì¹™ (ë¬¸ì¥ ì™„ì„±ë„ í•„ìˆ˜):**

**1ì¥ ìŠ¤í”„ë ˆë“œ:**
- âœ… ì¹´ë“œì˜ ì˜ë¯¸: 3-4ë¬¸ì¥ (ë°˜ë“œì‹œ ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê¸°)
- âœ… ì§ˆë¬¸ì— ëŒ€í•œ í•´ì„: 4-5ë¬¸ì¥ (ë°˜ë“œì‹œ ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê¸°)
- âœ… êµ¬ì²´ì  ì¡°ì–¸: 4-5ë¬¸ì¥ (ë°˜ë“œì‹œ ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê¸°)
- âœ… ì¢…í•© ì¡°ì–¸: 5-6ë¬¸ì¥ (ë°˜ë“œì‹œ ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê¸°)

**3ì¥ ì´ìƒ ìŠ¤í”„ë ˆë“œ:**
- âœ… ê° ì¹´ë“œì˜ ì˜ë¯¸: 2-3ë¬¸ì¥ (ë°˜ë“œì‹œ ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê¸°)
- âœ… ê° ì§ˆë¬¸ì— ëŒ€í•œ í•´ì„: 3-4ë¬¸ì¥ (ë°˜ë“œì‹œ ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê¸°)
- âœ… ê° êµ¬ì²´ì  ì¡°ì–¸: 3-4ë¬¸ì¥ (ë°˜ë“œì‹œ ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê¸°)
- âœ… ì¢…í•© ì¡°ì–¸: 5-6ë¬¸ì¥ (ë°˜ë“œì‹œ ì™„ì „í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ê¸°)

**âš ï¸ ì¤‘ìš”: ëª¨ë“  ë¬¸ì¥ì€ ë°˜ë“œì‹œ ë§ˆì¹¨í‘œ(.)ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤. ì¤‘ê°„ì— ëŠê¸°ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”.**

**ì¤‘ìš”:**
- ê° ì„¹ì…˜ ì‚¬ì´ì— ë¹ˆ ì¤„ 2ê°œ ë„£ê¸°
- êµ¬ë¶„ì„ ì€ ===ë¡œ í‘œì‹œ
- ëª¨ë“  í•´ì„ì€ ì‚¬ìš©ì ì§ˆë¬¸ê³¼ ì—°ê²°
- ë½‘ì€ ì¹´ë“œ ìˆ˜ë§Œí¼ë§Œ í•´ì„
- ê¹”ë”í•˜ê³  ì½ê¸° ì‰¬ìš´ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ì‘ì„±

í•œêµ­ì–´ë¡œ ìì—°ìŠ¤ëŸ½ê³  ëª…í™•í•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”.`,
      userPrompt: prompt,
      temperature: 0.7,
      maxTokens: calculatedMaxTokens,
      metadata: {
        userQuestion,
        cardCount: cardCount || 3,
        language: 'ko'
      }
    };

    logger.info(`Processing tarot request: ${aiRequest.id}`);

    const aiResponse = await aiOrchestrator.processRequest(aiRequest);

    if (!aiResponse.success) {
      throw new Error(aiResponse.error || 'AI ì‘ë‹µ ìƒì„± ì‹¤íŒ¨');
    }

    // ì‘ë‹µ ê²€ì¦ ë° ì •ì œ
    const cleanedResponse = cleanAIResponse(aiResponse.content);

    return res.json({
      success: true,
      response: cleanedResponse,
      provider: aiResponse.provider,
      model: aiResponse.model,
      timestamp: new Date().toISOString(),
    });
  } catch (error: any) {
    logger.error('[Tarot AI] Error:', error);

    // ì—ëŸ¬ ì‘ë‹µ
    return res.status(500).json({
      success: false,
      error: 'AI ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      details: error.message,
    });
  }
});

/**
 * AI ì‘ë‹µ ì •ì œ í•¨ìˆ˜ (ë§ˆí¬ë‹¤ìš´ ë³´ì¡´ ë²„ì „)
 * - <think> íƒœê·¸ë§Œ ì œê±°
 * - ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ì™„ì „ ë³´ì¡´
 * - ê¸°ë³¸ì ì¸ ì •ë¦¬ë§Œ ìˆ˜í–‰
 */
function cleanAIResponse(text: string): string {
  let cleaned = text;

  // 1. <think> íƒœê·¸ ë° ì‚¬ê³  ê³¼ì • ì œê±°
  cleaned = cleaned.replace(/<think>.*?<\/think>/gs, '');
  cleaned = cleaned.replace(/<\/?think>/g, '');

  // 2. ê¸°ë³¸ ê³µë°± ì •ë¦¬ë§Œ ìˆ˜í–‰
  cleaned = cleaned.replace(/\n{4,}/g, '\n\n\n'); // 4ê°œ ì´ìƒ ê°œí–‰ë§Œ ì œê±°
  cleaned = cleaned.trim();

  // 3. ìµœì†Œ ê¸¸ì´ ê²€ì¦
  if (cleaned.length < 20) {
    return 'ì£„ì†¡í•©ë‹ˆë‹¤. íƒ€ë¡œ í•´ì„ì„ ìƒì„±í•˜ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì§ˆë¬¸í•´ ì£¼ì„¸ìš”.';
  }

  return cleaned;
}

export default router;

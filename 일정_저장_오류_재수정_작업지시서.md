# 🔧 일정 저장 오류 재수정 작업지시서

## 🎯 문제 현황
- 할일(Todo)은 정상적으로 저장됨 ✅
- 일정(Event)이 저장되지 않음 ❌
- 이전 수정 사항이 제대로 적용되지 않은 것으로 추정

## 🔍 문제 진단 계획

### Phase 1: 현재 상태 확인
1. **브라우저 콘솔 확인**
   ```javascript
   // DevTools Console 탭에서 확인할 사항
   - 일정 저장 시 발생하는 에러 메시지
   - API 호출 시 전송되는 데이터 형식
   - 응답 메시지 및 상태 코드
   ```

2. **Network 탭 분석**
   ```
   - /api/calendar/events POST 요청 확인
   - Request Headers 확인
   - Request Payload 확인
   - Response 확인
   ```

3. **백엔드 로그 확인**
   ```bash
   # Calendar Service 로그에서 확인
   - 요청 수신 여부
   - Validation 에러
   - 데이터베이스 에러
   ```

## 🚨 예상 원인

### 1. 백엔드 서버 문제
- **이전 버전 코드 실행**: 수정한 코드가 반영되지 않음
- **포트 충돌**: 여러 프로세스가 동시에 실행 중
- **Hot Reload 미작동**: TypeScript 컴파일이 제대로 안 됨

### 2. API 통신 문제
- **프록시 설정 오류**: Vite 프록시가 제대로 작동하지 않음
- **CORS 에러**: 백엔드와 프론트엔드 간 CORS 정책 문제
- **엔드포인트 불일치**: API 경로가 일치하지 않음

### 3. 데이터 형식 문제
- **필드 불일치**: 프론트엔드와 백엔드 간 필드명 차이
- **타입 에러**: 날짜 형식, boolean 값 등의 타입 불일치
- **필수 필드 누락**: 백엔드에서 요구하는 필수 필드 미전송

## 🛠 상세 수정 계획

### Step 1: 프로세스 정리 (10분)
```bash
# 1. 모든 Node.js 프로세스 강제 종료
taskkill /F /IM node.exe

# 2. 포트 사용 현황 확인
netstat -ano | findstr ":4003"
netstat -ano | findstr ":4000"

# 3. 특정 PID 강제 종료 (필요시)
taskkill /PID [PID번호] /F
```

### Step 2: 백엔드 코드 검증 (15분)
```typescript
// events-sqlite.ts 확인 사항
1. reminders 필드 처리 로직
   - reminder_minutes > 0 ? [...] : []
   
2. 필드 변환 로직
   - start_time → start_datetime
   - end_time → end_datetime
   - all_day → is_all_day
   
3. Validation 로직
   - validateEvent() 함수 호출
   - 에러 메시지 처리
```

### Step 3: 프론트엔드 코드 검증 (15분)
```typescript
// EventModal.tsx 확인 사항
1. API 데이터 구성
   const apiData = {
     title: formData.title,
     description: formData.description,
     start_time: formData.start_time,
     end_time: formData.end_time,
     all_day: formData.all_day,
     location: formData.location,
     type: formData.type,
     color: formData.color,
     reminder_minutes: formData.reminder_minutes ?? null
   };

2. eventService 호출
   - createEvent() 메서드
   - updateEvent() 메서드
   
3. 에러 처리
   - catch 블록에서 상세 에러 로깅
```

### Step 4: API 서비스 검증 (10분)
```typescript
// api.ts 확인 사항
1. BASE_URL 설정
   const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:4003'

2. axios 설정
   - Content-Type: application/json
   - 에러 인터셉터

3. eventService 메서드
   - POST /api/calendar/events
   - 요청/응답 형식
```

### Step 5: 직접 API 테스트 (10분)
```bash
# curl로 직접 테스트
curl -X POST http://localhost:4003/api/calendar/events \
  -H "Content-Type: application/json" \
  -d '{
    "title": "테스트 일정",
    "description": "테스트",
    "start_time": "2025-09-04T10:00:00",
    "end_time": "2025-09-04T11:00:00",
    "all_day": false,
    "type": "personal",
    "color": "#3b82f6",
    "reminder_minutes": null
  }'
```

## 🔧 구체적 수정 방안

### 옵션 1: 백엔드 재구성
```bash
# 1. 백엔드 완전 재시작
cd packages/backend/services/calendar
npm run build  # TypeScript 빌드
PORT=4003 npm start  # 또는 npm run dev
```

### 옵션 2: 디버깅 모드 실행
```typescript
// EventModal.tsx에 디버깅 코드 추가
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  
  // 디버깅: 전송 데이터 확인
  console.log('=== Event Save Debug ===');
  console.log('Form Data:', formData);
  console.log('API Data:', apiData);
  console.log('API URL:', API_URL);
  
  try {
    const response = await eventService.createEvent(apiData);
    console.log('Success Response:', response);
  } catch (error) {
    console.error('=== Error Details ===');
    console.error('Error Object:', error);
    console.error('Error Response:', error.response);
    console.error('Error Data:', error.response?.data);
  }
};
```

### 옵션 3: Vite 프록시 우회
```typescript
// api.ts 수정 - 직접 백엔드 URL 사용
const API_URL = 'http://localhost:4003';  // 프록시 우회

// 또는 EventModal에서 직접 fetch 사용
const response = await fetch('http://localhost:4003/api/calendar/events', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(apiData)
});
```

## 📋 체크리스트

### 진단 단계
- [ ] 브라우저 콘솔에서 정확한 에러 메시지 확인
- [ ] Network 탭에서 API 요청/응답 확인
- [ ] 백엔드 서버 로그 확인
- [ ] 데이터베이스 연결 상태 확인

### 수정 단계
- [ ] 백엔드 코드가 최신 버전인지 확인
- [ ] 프론트엔드 코드가 최신 버전인지 확인
- [ ] API 엔드포인트 일치 확인
- [ ] 데이터 필드명 일치 확인
- [ ] 타입 변환 로직 확인

### 검증 단계
- [ ] curl로 직접 API 테스트
- [ ] 브라우저에서 일정 생성 테스트
- [ ] 일정 수정 테스트
- [ ] 일정 삭제 테스트

## 🎯 최종 해결 방안

### 즉시 실행 가능한 수정
1. **백엔드 서버 완전 재시작**
   ```bash
   # 모든 프로세스 종료 후 재시작
   taskkill /F /IM node.exe
   cd packages/backend/services/calendar
   PORT=4003 npx ts-node --transpile-only src/index.ts
   ```

2. **프론트엔드 서버 재시작**
   ```bash
   cd packages/web
   PORT=4000 npx vite --port 4000
   ```

3. **브라우저 캐시 클리어**
   - Ctrl + Shift + R (강제 새로고침)
   - DevTools > Application > Clear Storage

## 📊 예상 작업 시간
- **총 소요 시간**: 약 1시간
- **진단**: 20분
- **수정**: 30분
- **테스트**: 10분

## ✅ 완료 기준
- [ ] 일정 생성이 정상 동작
- [ ] 일정 수정이 정상 동작
- [ ] 일정 삭제가 정상 동작
- [ ] 에러 메시지 없이 저장 완료
- [ ] 캘린더에 일정이 표시됨

---
**우선순위**: 🔴 긴급
**영향 범위**: 캘린더 핵심 기능
**작성일**: 2025-09-04
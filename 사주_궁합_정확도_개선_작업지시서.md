# 궁합 분석 정확도 개선 작업지시서

## 📋 문제 현황
- 궁합 페이지가 목업 데이터를 사용하는 것으로 보임
- 실제 사주 데이터와 궁합 계산 결과가 일치하지 않음
- 정확한 만세력 기반 사주 계산 로직을 궁합에 적용 필요

## 🎯 작업 목표
**궁합 분석에 정확한 사주 데이터를 적용하여 신뢰할 수 있는 궁합 점수 제공**

## 🔍 1단계: 사주 데이터 정확성 검증

### 1.1 고객 사주 데이터베이스 확인
```sql
-- 고객 사주 데이터 샘플 확인
SELECT 
  name, 
  birth_date, 
  birth_time, 
  saju_data,
  created_at
FROM customers 
ORDER BY created_at DESC 
LIMIT 5;
```

### 1.2 사주 데이터 구조 검증
```typescript
// packages/web/src/pages/CompatibilityPage.tsx:36-37에서
const saju1 = JSON.parse(person1.saju_data || '{}');
const saju2 = JSON.parse(person2.saju_data || '{}');

// 확인 필요한 필드들:
// - year: { gan: string, ji: string }
// - month: { gan: string, ji: string }
// - day: { gan: string, ji: string }  
// - time: { gan: string, ji: string }
// - ohHaengBalance: { 목: number, 화: number, 토: number, 금: number, 수: number }
// - fullSaju: string
```

### 1.3 검증 스크립트 작성
```javascript
// packages/backend/services/calendar/verify-compatibility-saju.js
const sqlite3 = require('sqlite3').verbose();
const { calculateAccurateSaju } = require('./src/utils/accurateSajuCalculator');

// 고객별 사주 데이터 정확성 검증
// 데이터베이스의 saju_data와 재계산 결과 비교
```

## 🛠 2단계: 궁합 계산 로직 정확성 확인

### 2.1 CompatibilityCalculator 함수 점검
```typescript
// packages/web/src/utils/compatibilityCalculator.ts
// 핵심 확인 사항:
// 1. SajuData 인터페이스가 실제 DB 데이터와 일치하는가?
// 2. 십신 계산 로직이 정확한가?
// 3. 오행 상생상극 관계가 올바른가?
// 4. 지지 삼합/육합/충 관계가 정확한가?
```

### 2.2 실제 궁합 계산 테스트
```typescript
// 테스트용 실제 고객 데이터로 검증
const testCustomer1 = {
  name: "테스트1",
  birth_date: "1971-11-17", 
  birth_time: "04:00",
  saju_data: "신해 기해 병오 경인" // 정확히 계산된 사주
};

const testCustomer2 = {
  name: "테스트2", 
  birth_date: "1985-03-15",
  birth_time: "14:30",
  saju_data: "을축 기묘 정미 정미" // 예시
};
```

## 🔧 3단계: 정확한 사주 데이터 적용

### 3.1 사주 데이터 파싱 로직 개선
```typescript
// packages/web/src/pages/CompatibilityPage.tsx 수정 필요
const parseAccurateSaju = (sajuData: string) => {
  try {
    const parsed = JSON.parse(sajuData);
    
    // 필수 필드 검증
    if (!parsed.year || !parsed.month || !parsed.day || !parsed.time) {
      throw new Error('사주 데이터가 불완전합니다');
    }
    
    // 오행 균형 데이터 검증
    if (!parsed.ohHaengBalance) {
      console.warn('오행 균형 데이터가 없습니다');
    }
    
    return parsed;
  } catch (error) {
    console.error('사주 데이터 파싱 오류:', error);
    return null;
  }
};
```

### 3.2 궁합 계산 함수 호출부 수정
```typescript
// 정확한 사주 데이터 적용
const saju1 = parseAccurateSaju(person1.saju_data);
const saju2 = parseAccurateSaju(person2.saju_data);

if (!saju1 || !saju2) {
  console.error('사주 데이터 파싱 실패');
  return;
}

// 실제 사주 데이터로 궁합 계산
const categories = [
  { 
    name: '성격 궁합', 
    score: calculateAccuratePersonalityScore(saju1, saju2),
    description: '성격과 가치관의 조화 (십신/오행 분석)' 
  },
  // ... 나머지 카테고리들
];
```

## 🧪 4단계: 궁합 점수 정확도 검증

### 4.1 실제 고객 데이터로 테스트
```bash
# 브라우저 콘솔에서 확인
cd packages/web
npm start

# 궁합 페이지에서:
# 1. 실제 고객 2명 선택
# 2. 궁합 분석하기 클릭  
# 3. 브라우저 개발자 도구 콘솔에서 로그 확인
# 4. 계산된 점수와 사주 데이터 일치성 확인
```

### 4.2 수동 검증 체크리스트
- [ ] 사주 데이터가 JSON.parse() 오류 없이 파싱되는가?
- [ ] year/month/day/time 각 주의 간지가 올바른가?
- [ ] 오행 균형 데이터가 존재하는가?
- [ ] 십신 관계 계산이 정확한가?
- [ ] 상생상극 관계가 올바르게 반영되는가?
- [ ] 궁합 점수가 합리적 범위(0-100) 내에 있는가?

### 4.3 비교 검증
```typescript
// 기존 목업 데이터 vs 실제 사주 데이터 비교
const mockResult = calculateWithMockData();
const realResult = calculateWithRealSaju(saju1, saju2);

console.log('목업 결과:', mockResult);
console.log('실제 결과:', realResult);
console.log('차이점:', compareResults(mockResult, realResult));
```

## 📊 5단계: 결과 검증 및 문서화

### 5.1 검증 결과 정리
- 사주 데이터 정확성: ✅/❌
- 궁합 계산 로직: ✅/❌  
- 실제 데이터 적용: ✅/❌
- 점수 신뢰성: ✅/❌

### 5.2 개선 사항 문서화
```markdown
## 궁합 분석 개선 결과
- 기존 문제점: [발견된 문제들]
- 적용된 해결책: [구체적 수정 사항]
- 개선된 정확도: [전후 비교]
- 추가 필요 작업: [향후 계획]
```

## ⚠️ 주의사항
1. **데이터 백업**: 사주 데이터 수정 전 반드시 백업
2. **점진적 테스트**: 한 번에 모든 기능을 변경하지 말고 단계별 검증
3. **사용자 경험**: 궁합 계산 시간이 과도하게 길어지지 않도록 주의
4. **에러 핸들링**: 사주 데이터 파싱 오류 시 적절한 안내 메시지 제공

## 🎯 최종 목표 검증 기준
**실제 고객의 생년월일시로 계산된 정확한 사주 데이터를 기반으로 신뢰할 수 있는 궁합 분석 결과를 제공하는 것**

---
*작성일: 2025-09-03*
*작업 담당: Claude Code*
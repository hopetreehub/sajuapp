# 사주 고객관리 시스템 구축 작업지시서

## 📋 프로젝트 개요
사용자의 사주 정보를 무한 저장하고, 저장된 사주 데이터를 기반으로 모든 차트가 동적으로 연동되는 고객 관리 시스템 구축

## 🎯 핵심 요구사항

### 1. 고객 정보 저장
- **필수 입력 항목**:
  - 이름 (한글/영문)
  - 생년월일시 (년/월/일/시)
  - 전화번호
  - 음력/양력 구분
  - 성별

### 2. 무한 저장 기능
- SQLite 데이터베이스에 고객 정보 무제한 저장
- 고객 목록 조회/검색/수정/삭제 기능
- 중복 체크 (이름+전화번호)

### 3. 사주 차트 연동
- 선택된 고객의 사주 데이터로 모든 차트 자동 갱신
- 9개 대항목 레이더차트 점수 실시간 계산
- 시간대별 운세 변화 반영

## 🏗️ 시스템 아키텍처

```
┌─────────────────────────────────────┐
│         프론트엔드 (React)           │
├─────────────────────────────────────┤
│  1. 고객 관리 페이지                 │
│     - 고객 등록 폼                   │
│     - 고객 목록 테이블               │
│     - 검색/필터 기능                 │
│  2. 사주 분석 페이지                 │
│     - 고객 선택 드롭다운             │
│     - 선택된 고객 정보 표시          │
│     - 동적 차트 렌더링               │
└─────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────┐
│      백엔드 API (Node.js)            │
├─────────────────────────────────────┤
│  /api/customers                      │
│    - POST   : 고객 등록              │
│    - GET    : 고객 목록 조회         │
│    - GET/:id: 고객 상세 조회         │
│    - PUT/:id: 고객 정보 수정         │
│    - DELETE/:id: 고객 삭제          │
│  /api/saju/calculate                 │
│    - POST   : 사주 계산              │
└─────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────┐
│       데이터베이스 (SQLite)          │
├─────────────────────────────────────┤
│  customers 테이블:                   │
│    - id (자동증가)                   │
│    - name (이름)                     │
│    - birth_date (생년월일)           │
│    - birth_time (시간)               │
│    - phone (전화번호)                │
│    - lunar_solar (음력/양력)         │
│    - gender (성별)                   │
│    - created_at                      │
│    - updated_at                      │
└─────────────────────────────────────┘
```

## 📝 상세 구현 계획

### Phase 1: 백엔드 고객 관리 API (1일)
```javascript
// customer.service.js
class CustomerService {
  // 고객 등록
  async createCustomer(data) {
    // 사주 계산 로직 포함
    const sajuData = calculateSaju(data.birthDate, data.birthTime);
    return db.customers.create({ ...data, sajuData });
  }
  
  // 고객 목록 조회 (페이지네이션)
  async getCustomers(page, limit, search) {
    return db.customers.findAll({ 
      where: search ? { name: { like: `%${search}%` } } : {},
      limit, 
      offset: (page - 1) * limit 
    });
  }
  
  // 고객 상세 조회
  async getCustomerById(id) {
    const customer = await db.customers.findById(id);
    customer.sajuData = calculateSaju(customer.birthDate, customer.birthTime);
    return customer;
  }
}
```

### Phase 2: 프론트엔드 고객 관리 UI (1일)
```typescript
// CustomerManagementPage.tsx
interface Customer {
  id: number;
  name: string;
  birthDate: string;
  birthTime: string;
  phone: string;
  lunarSolar: 'lunar' | 'solar';
  gender: 'male' | 'female';
  sajuData?: SajuData;
}

const CustomerManagementPage = () => {
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [selectedCustomer, setSelectedCustomer] = useState<Customer | null>(null);
  
  return (
    <div>
      {/* 고객 등록 폼 */}
      <CustomerRegistrationForm onSubmit={handleSubmit} />
      
      {/* 고객 목록 */}
      <CustomerList 
        customers={customers}
        onSelect={setSelectedCustomer}
        onDelete={handleDelete}
        onEdit={handleEdit}
      />
      
      {/* 검색/필터 */}
      <SearchFilter onSearch={handleSearch} />
    </div>
  );
};
```

### Phase 3: 사주 계산 엔진 통합 (1일)
```typescript
// sajuCalculationEngine.ts
export class SajuCalculationEngine {
  // 생년월일시를 사주 팔자로 변환
  calculatePalja(birthDate: Date, birthTime: string): SajuData {
    const year = this.getYearPillar(birthDate);
    const month = this.getMonthPillar(birthDate);
    const day = this.getDayPillar(birthDate);
    const time = this.getTimePillar(birthTime);
    
    return {
      year: { gan: year.gan, ji: year.ji },
      month: { gan: month.gan, ji: month.ji },
      day: { gan: day.gan, ji: day.ji },
      time: { gan: time.gan, ji: time.ji },
      ohHaengBalance: this.calculateOhHaengBalance(year, month, day, time)
    };
  }
  
  // 오행 균형 계산
  calculateOhHaengBalance(year, month, day, time): OhHaengBalance {
    // 목/화/토/금/수 각각의 강도 계산
    return {
      목: this.calculateWoodStrength(year, month, day, time),
      화: this.calculateFireStrength(year, month, day, time),
      토: this.calculateEarthStrength(year, month, day, time),
      금: this.calculateMetalStrength(year, month, day, time),
      수: this.calculateWaterStrength(year, month, day, time)
    };
  }
}
```

### Phase 4: 차트 연동 시스템 (1일)
```typescript
// UnifiedSajuAnalysisPage.tsx 수정
const UnifiedSajuAnalysisPage = () => {
  const [selectedCustomerId, setSelectedCustomerId] = useState<number | null>(null);
  const [customer, setCustomer] = useState<Customer | null>(null);
  const [sajuData, setSajuData] = useState<SajuData | null>(null);
  
  // 고객 선택 시 사주 데이터 로드
  useEffect(() => {
    if (selectedCustomerId) {
      fetchCustomerWithSaju(selectedCustomerId).then(data => {
        setCustomer(data);
        setSajuData(data.sajuData);
      });
    }
  }, [selectedCustomerId]);
  
  // 차트 데이터 동적 계산
  const chartData = useMemo(() => {
    if (!sajuData) return null;
    
    return SAJU_RADAR_CATEGORIES.map(category => ({
      ...category,
      subcategories: category.subcategories.map(sub => ({
        ...sub,
        items: sub.items.map(item => ({
          ...item,
          baseScore: calculateSajuScore(item.name, sajuData)
        }))
      }))
    }));
  }, [sajuData]);
  
  return (
    <div>
      {/* 고객 선택 드롭다운 */}
      <CustomerSelector 
        onSelect={setSelectedCustomerId}
        selectedId={selectedCustomerId}
      />
      
      {/* 선택된 고객 정보 표시 */}
      {customer && (
        <CustomerInfoCard customer={customer} />
      )}
      
      {/* 동적 차트 렌더링 */}
      {chartData && (
        <UnifiedSajuRadarChart 
          data={chartData}
          sajuData={sajuData}
          birthDate={customer?.birthDate}
        />
      )}
    </div>
  );
};
```

### Phase 5: 데이터베이스 스키마 (0.5일)
```sql
-- customers 테이블
CREATE TABLE customers (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  birth_date DATE NOT NULL,
  birth_time TIME NOT NULL,
  phone TEXT NOT NULL,
  lunar_solar TEXT CHECK(lunar_solar IN ('lunar', 'solar')) DEFAULT 'solar',
  gender TEXT CHECK(gender IN ('male', 'female')) NOT NULL,
  memo TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(name, phone)
);

-- 인덱스
CREATE INDEX idx_customers_name ON customers(name);
CREATE INDEX idx_customers_phone ON customers(phone);
CREATE INDEX idx_customers_birth_date ON customers(birth_date);
```

## 🔧 구현 순서

### Step 1: 백엔드 API 구축
1. SQLite 데이터베이스 스키마 생성
2. Customer 모델 및 서비스 구현
3. REST API 엔드포인트 구현
4. 사주 계산 로직 통합

### Step 2: 프론트엔드 고객 관리
1. 고객 등록 폼 컴포넌트
2. 고객 목록 테이블 컴포넌트
3. 검색/필터 기능
4. 고객 선택 드롭다운

### Step 3: 사주 차트 연동
1. 고객별 사주 데이터 계산
2. 차트 컴포넌트에 동적 데이터 주입
3. 실시간 점수 업데이트
4. 시간대별 운세 변화 반영

### Step 4: 테스트 및 최적화
1. 대량 데이터 테스트 (1000명+)
2. 검색 성능 최적화
3. 차트 렌더링 성능 개선
4. 에러 처리 및 유효성 검증

## 📊 UI/UX 디자인

### 고객 등록 폼
```
┌─────────────────────────────────────┐
│        고객 정보 등록                │
├─────────────────────────────────────┤
│ 이름*    : [_______________]        │
│ 생년월일* : [____-__-__]            │
│ 생시*    : [__:__] (24시간)         │
│ 음/양력  : (●) 양력 ( ) 음력        │
│ 성별*    : (●) 남 ( ) 여            │
│ 전화번호* : [___-____-____]         │
│ 메모     : [_______________]        │
│                                     │
│        [취소]  [등록하기]           │
└─────────────────────────────────────┘
```

### 고객 목록 테이블
```
┌─────────────────────────────────────┐
│ 🔍 검색: [___________] [검색]       │
├─────────────────────────────────────┤
│ No │ 이름 │ 생년월일 │ 전화번호 │ │
├────┼──────┼──────────┼──────────┼─┤
│ 1  │ 홍길동│1990.01.01│010-1234..│🔧│
│ 2  │ 김철수│1985.05.15│010-5678..│🔧│
│ 3  │ 이영희│1992.12.25│010-9012..│🔧│
└─────────────────────────────────────┘
 < 1 2 3 4 5 > 
```

### 고객 선택 및 차트 표시
```
┌─────────────────────────────────────┐
│ 고객 선택: [홍길동 ▼]              │
├─────────────────────────────────────┤
│ 📋 고객 정보                        │
│ • 이름: 홍길동                      │
│ • 생년월일시: 1990.01.01 14:30      │
│ • 사주: 경오년 정축월 무진일 기미시  │
├─────────────────────────────────────┤
│        [레이더 차트 표시]            │
│         개인화된 점수 반영           │
└─────────────────────────────────────┘
```

## ⚡ 성능 고려사항

1. **페이지네이션**: 고객 목록은 20명씩 페이지 처리
2. **검색 최적화**: 이름/전화번호 인덱싱
3. **캐싱**: 자주 조회되는 고객 데이터 캐싱
4. **지연 로딩**: 차트는 고객 선택 시에만 계산

## 🔒 보안 고려사항

1. **개인정보 보호**: 전화번호 마스킹 처리
2. **접근 권한**: 로그인 사용자만 접근 가능
3. **데이터 암호화**: 민감 정보 암호화 저장
4. **백업**: 정기적인 데이터베이스 백업

## 📅 일정

- **Day 1**: 백엔드 API 및 데이터베이스 구축
- **Day 2**: 프론트엔드 고객 관리 UI 구현
- **Day 3**: 사주 계산 엔진 통합 및 차트 연동
- **Day 4**: 테스트 및 최적화

## ✅ 체크리스트

### 백엔드
- [ ] SQLite 데이터베이스 설정
- [ ] customers 테이블 생성
- [ ] Customer 모델 구현
- [ ] REST API 엔드포인트 구현
- [ ] 사주 계산 로직 통합

### 프론트엔드
- [ ] 고객 등록 폼
- [ ] 고객 목록 테이블
- [ ] 검색/필터 기능
- [ ] 고객 선택 드롭다운
- [ ] 고객 정보 카드

### 연동
- [ ] 선택된 고객의 사주 데이터 로드
- [ ] 차트에 동적 점수 반영
- [ ] 실시간 업데이트
- [ ] 에러 처리

## 🚀 시작 명령

작업 준비가 완료되었습니다. 이 작업지시서를 기반으로 고객 관리 시스템을 구축하겠습니다.